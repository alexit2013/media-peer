<!DOCTYPE HTML>
<html lang="en">
<head>
<title>PeerJS chat demo</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Language" content="en-us">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="/css/fancy.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
<script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/js.cookie.js"></script>
<script type="text/javascript" src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.js"></script>

<script type="text/javascript" src="/demo/terminal2.js"></script>
<style media="screen">
    .mybar div {
        margin: 0 0 0 0;
    }
</style>
<script>
// Connect to PeerJS, have server assign an ID instead of providing one
// Showing off some of the configs available with PeerJS :).
var peer = new Peer({
    // Set API key for cloud server (you don't need this if you're running your
    // own.
    //key: 'x7fwx2kavpy6tj4i',
    host: window.location.hostname, port: window.location.port || null, path: '/peerjs',
    config: {'iceServers': [
        { url: 'stun:stun.l.google.com:19302' },
        { url: 'turn:homeo@turn.bistri.com:80', credential: 'homeo' }
    ]}, /* Sample servers, please use appropriate ones */

    // Set highest debug level (log everything!).
    debug: 3,

    // Set a logging function:
    logFunction: function() {
        if (arguments.length == 3 && arguments[2].type == 'PEER-LIST') {
            var peerList = arguments[2].payload.peers;
            $('.log').append('PEER-LIST ' + JSON.stringify(peerList) + '<br>');
            var domPeerList = $('#peerlist');
            domPeerList.empty();
            for (var i = 0; i < peerList.length; i ++) {
                var item = $('#peerlist-item-template').clone();
                item.removeAttr('id');
                item.attr('peerid', peerList[i][0]);
                item.find('#peerlist-item-nickname').text(peerList[i][1] || peerList[i][0]);
                if (peerList[i][0] == peer.id)
                    item.find('#peerlist-item-nickname').append(' (You)');
                if (peerList[i][0] == $('#rid').val())
                    item.addClass('active');
                domPeerList.append(item);
                item.show();
            }
            $('.peerlist-item').click(function() {
                if ($(this).attr('peerid') == peer.id)
                    return;
                $('.peerlist-item').removeClass("active");
                $(this).addClass('active');
                $("#rid").val($(this).attr("peerid"));
            });
            connectToFirstPeerOnOpen();
        } else {
            var copy = Array.prototype.slice.call(arguments).join(' ');
            $('.log').append(copy + '<br>');
        }
    }
});

var connectedToFirstPeerOnOpen = false;
function connectToFirstPeerOnOpen() {
    if (Object.keys(peer.connections).length)
        connectedToFirstPeerOnOpen = true;
    $("#peerlist .peerlist-item").each(function(k,v) {
        if (!connectedToFirstPeerOnOpen) {
            var peerid = $(v).attr('peerid');
            if (peerid != peer.id) {
                console.log(1);
                $('#rid').val(peerid);
                $('#connect').click();
                connectedToFirstPeerOnOpen = true;
            }
        }
    });
}

var connectedPeers = {};

// Show this peer's ID.
peer.on('open', function(id){
    // Set nickname
    var nickname = Cookies.get('nickname');
    $('#nickname').val(nickname);
    peer.socket.send({type: 'USERDEFINED', payload:{type: 'NICKNAME', payload: nickname}});
});

// Await connections from others
peer.on('connection', connect);

peer.on('error', function(err) {
    console.log(err);
})

function setPeerBoxHeight() {
    var toolsHeight = $('#tools').height();
    $('#peerbox').height(toolsHeight);
}

var myvideos = {};
// Handle a connection object.
function connect(c) {
    // Handle a chat connection.
    setPeerBoxHeight();
    if (c.label === 'chat') {
        var chatbox = $('<div></div>').addClass('connection').addClass('active').attr('id', c.peer);
        var header = $('<div></div>').html('<p>Chat with <strong>' + c.peer + '</strong><p>').addClass('chatheader');
        var messages = $('<div><em>Peer connected.</em></div>').addClass('messages');
        chatbox.append(header);
        chatbox.append(messages);

        // Select connection handler.
        chatbox.on('click', function() {
            if ($(this).attr('class').indexOf('active') === -1) {
                $(this).addClass('active');
            } else {
                $(this).removeClass('active');
            }
        });
        $('.filler').hide();
        $('#connections').append(chatbox);

        c.on('data', function(data) {
            messages.append('<div><span class="peer">' + c.peer + '</span>: ' + data +
                '</div>');
                });
                c.on('close', function() {
                    // alert(c.peer + ' has left the chat.');
                    chatbox.remove();
                    if ($('.connection').length === 0) {
                        $('.filler').show();
                    }
                    delete connectedPeers[c.peer];
                });
    } else if (c.label === 'file') {
        c.on('data', function(data) {
            console.log(data);
            if (data.type == 'file') {

                if (window.mytimer) {
                    window.mytimer ++;
                    console.timeEnd(1);
                } else {
                    window.mytimer = 1;
                    console.time(1);
                }
                console.log(window.mytimer);

                // If we're getting a file, create a URL for it.
                console.assert(data.file.constructor === ArrayBuffer);
                var dataView = new Uint8Array(data.file);
                var dataBlob = new Blob([dataView]);
                var url = window.URL.createObjectURL(dataBlob);
                $('#' + c.peer).find('.messages').append('<div><span class="file">' +
                        c.peer + ' has sent you a <a target="_blank" href="' + url + '">file</a>.</span></div>');
            } else if (data.type == 'image') {
                console.assert(data.file.constructor === ArrayBuffer);
                var dataView = new Uint8Array(data.file);
                var dataBlob = new Blob([dataView]);
                var url = window.URL.createObjectURL(dataBlob);
                $('#' + c.peer).find('.messages').append('<div><span class="peer">' + c.peer + '</span>: <span><img class="recieved-image" src="' +
                        url + '"/></span></div>');
            } else if (data.type == 'video') {
                function noname() {
                    var dataView = new Uint8Array(data.file.data);
                    var dataBlob = new Blob([dataView]);
                    var url = window.URL.createObjectURL(dataBlob);
                    var fid = data.file.fid + "";
                    var segid = data.file.segid;
                    fid = fid.substr(2);
                    var video = myvideos[fid];
                    //video.video_dom.src = url;
                    mainbar = $(video.bar_dom).find(".main-bar");
                    var total = video.finfo.total;
                    var segs = video.finfo.segs;
                    var start = segs[segid] / total;
                    var end = segs[segid+1] / total;
                    mainbar.prepend('<div style="position: absolute;left: ' + start*100 + '%;width: '+ (end-start)*100 +'% ;height: 20px;background-color: green;"></div>');
                    video.urls[segid] = url;
                    video.check_play();
                };
                noname();
            } else if (data.type == 'video-info') {
                function noname() {
                    var fid = data.file.fid + "";
                    fid = fid.substr(2);
                    var video = myvideos[fid] = {finfo: data.file, urls:[], c_seg:0, pg:0.0};
                    m = Math.floor(data.file.total/60);
                    s = data.file.total - m*60;
                    $('#' + c.peer).find('.messages').append('<div><span class="peer">' + c.peer + '</span>: <span><video style="height:375px" id="' + fid + '" class="recieved-video">Your browser does not support the video tag.</video>' +
                    '<div style="margin:0 0 0 0;" class="mybar mybar-' + fid + '"><icon class="play-btn" style="   float: left;"><a>â–º</a></icon><div class="main-bar" style="position: relative;margin:0 0 0 0;float:left;width: 80%;height: 20px;background-color: black;"><div class="mycursor" style="position: absolute;width: 5px;height: 20px;background-color: red;"></div><div class="mycover" style="position: absolute;width: 100%;height: 20px;background-color: rgba(255,255,255,0);"></div></div>  <div class="mytime">00:00</div><div> /' + m + ':' + Math.floor(s) +  '</div></div>' +
                    '</span></div>');
                    var video_dom = video.video_dom = $("#"+fid)[0];
                    var bar_dom = video.bar_dom = $(".mybar-"+fid)[0];
                    var total = video.finfo.total;
                    var segs = video.finfo.segs;
                    var mycover = video.mycover = $(bar_dom).find(".mycover");
                    var mycursor = video.mycursor = $(bar_dom).find(".mycursor");
                    var mybtn = video.mybtn = $(bar_dom).find(".play-btn");
                    var mytime = video.mytime = $(bar_dom).find(".mytime");

                    video_dom.onended = function() {
                        if (video.c_seg == video.finfo.segs.length - 2) {
                            video.pg = 0;
                            video.check_play();
                            video_dom.ontimeupdate();
                        } else {
                            var i = video.c_seg + 1;
                            var url = video.urls[i];
                            if (url) {
                                if (video.video_dom.src != url) {
                                    video.video_dom.src = url;
                                    video.c_seg = i;
                                }
                                video.video_dom.currentTime = 0;
                                video.video_dom.play();
                            }
                        }
                    }

                    video_dom.ontimeupdate = function() {
                        var now = video_dom.currentTime + video.finfo.segs[video.c_seg];
                        video.pg = now / video.finfo.total;
                        mycursor.css("left", video.pg*100 + "%");
                        m = Math.floor(now/60);
                        s = Math.floor(now - m*60);
                        video.mytime.html(m + ':' + s);
                    }

                    video.check_play = function() {
                        var i = 0;
                        var pts = video.pg * video.finfo.total;
                        for (;i<video.finfo.segs.length && video.finfo.segs[i]<pts; i++);
                        i--;
                        if (i<0) i=0;
                        var url = video.urls[i];
                        if (url) {
                            if (video.video_dom.src != url) {
                                video.video_dom.src = url;
                                video.c_seg = i;
                            }
                            video.video_dom.currentTime = pts - video.finfo.segs[i];
                        }
                    };

                    video.play = function() {
                        var i = 0;
                        var pts = video.pg * video.finfo.total;
                        for (;i<video.finfo.segs.length && video.finfo.segs[i]<pts; i++);
                        i--;
                        if (i<0) i=0;
                        var url = video.urls[i];
                        if (url) {
                            if (video.video_dom.src != url) {
                                video.video_dom.src = url;
                                video.c_seg = i;
                            }
                            video_dom.play();
                        }
                    }

                    mybtn.on("click", function() {
                        video.play();
                    });
                    segs.push(total);
                    $(bar_dom).find(".mycover").on('click', function (e) {
                        console.log(e);
                        var pg = e.offsetX / mycover.width();

                        mycursor.css("left", pg*100 + "%");
                        video.pg = pg;
                        video.check_play();
                    });
                };
                noname();
            }
        });
    }
    connectedPeers[c.peer] = 1;
}

$(document).ready(function() {
    // Set peerbox height
    setPeerBoxHeight();

    // Save nickname
    $('#saveNickname').click(function() {
        var nickname = $('#nickname').val();
        Cookies.set('nickname', nickname, { expires: 365 });
        peer.socket.send({type: 'USERDEFINED', payload: {type: 'NICKNAME', payload: nickname}});
    });

    // Prepare file drop box.
    var box = $('#box');
    box.on('dragenter', doNothing);
    box.on('dragover', doNothing);
    box.on('drop', function(e){
        e.originalEvent.preventDefault();
        var file = e.originalEvent.dataTransfer.files[0];
        if (file.type.startsWith('video')) {
            var arrayBuffer;
            var fileReader = new FileReader();
            fileReader.onload = function() {
                arrayBuffer = new Uint8Array(this.result);
                console.log("Read file done, total length: " + this.result.byteLength);
                fname = file.name.split('.');
                fname = fname[fname.length-1];
                cmd = "-v 40 -i input."+fname + " -acodec copy -f segment -vcodec copy -reset_timestamps 1 -map 0 OUTPUT%d." + fname;
                files = [{name:'input.'+fname, data:arrayBuffer}];
                fid = Math.random();
                myCommand(cmd, files, function(buffers, finfo) {
                    finfo.fid = fid;
                    eachActiveConnection(function(c, $c) {
                        if (c.label === 'file' && c.open) {
                            c.send({type:"video-info", file:finfo});
                        }
                    });
                    for (var i=0; i<buffers.length; i++) {
                        eachActiveConnection(function(c, $c) {
                            if (c.label === 'file' && c.open) {
                                ftype = 'video';
                                c.send({type:ftype, file:{fid:fid, segid:i,data:buffers[i].data}});
                                $c.find('.messages').append('<div><span class="file">You sent a ' + buffers[i].name + '.</span></div>');
                            }
                        });
                    }
                });
            };
            fileReader.readAsArrayBuffer(file);
        } else {
            eachActiveConnection(function(c, $c) {
                if (c.label === 'file' && c.open) {
                    var ftype = 'file';
                    if (file.type.startsWith('image'))
                        ftype = 'image';
                    else if (file.type.startsWith('video'))
                        ftype = 'video';
                    else
                        ftype = 'file';
                    c.send({type:ftype,file:file});
                    setInterval(function() {

                        if (window.mytimer) {
                            window.mytimer ++;
                            console.timeEnd(1);
                        } else {
                            window.mytimer = 1;
                            console.time(1);
                        }
                        console.log(window.mytimer);


                        c.send({type:ftype,file:file});
                        console.log(c.bufferSize);
                    }, 10);
                    var url = window.URL.createObjectURL(file);
                    if (ftype == 'file')
                        $c.find('.messages').append('<div><span class="file">You sent a <a target="_blank" href="' + url + '">file</a>.</span></div>');
                    else if (ftype == 'image')
                        $c.find('.messages').append('<div><span class="you">You: </span><span><img class="recieved-image" src="' +
                            url + '"/></span></div>');
                    else if (ftype == 'video')
                        $c.find('.messages').append('<div><span class="you">You: </span><span><video class="recieved-video" src="' +
                            url + '" controls="controls">Your browser does not support the video tag.</video></span></div>');
                }
            });
        }
    });
    function doNothing(e){
        e.preventDefault();
        e.stopPropagation();
    }

    // Connect to a peer
    $('#connect').click(function() {
        var requestedPeer = $('#rid').val();
        if (!connectedPeers[requestedPeer]) {
            // Create 2 connections, one labelled chat and another labelled file.
            var c = peer.connect(requestedPeer, {
                label: 'chat',
                serialization: 'none',
                metadata: {message: 'hi i want to chat with you!'}
            });
            c.on('open', function() {
                connect(c);
            });
            c.on('error', function(err) { alert(err); });
            var f = peer.connect(requestedPeer, { label: 'file', reliable: true });
            f.on('open', function() {
                connect(f);
            });
            f.on('error', function(err) { alert(err); });
        }
        connectedPeers[requestedPeer] = 1;
    });

    // Close a connection.
    $('#close').click(function() {
        eachActiveConnection(function(c) {
            c.close();
        });
    });

    // Send a chat message to all active connections.
    $('#send').submit(function(e) {
        e.preventDefault();
        // For each active connection, send the message.
        var msg = $('#text').val();
        eachActiveConnection(function(c, $c) {
            if (c.label === 'chat' && c.open) {
                c.send(msg);
                $c.find('.messages').append('<div><span class="you">You: </span>' + msg
                    + '</div>');
            }
        });
        $('#text').val('');
        $('#text').focus();
    });

    // Goes through each active peer and calls FN on its connections.
    function eachActiveConnection(fn) {
        var actives = $('.connection.active');
        var checkedIds = {};
        actives.each(function() {
            var peerId = $(this).attr('id');

            if (!checkedIds[peerId]) {
                var conns = peer.connections[peerId];
                for (var i = 0, ii = conns.length; i < ii; i += 1) {
                    var conn = conns[i];
                    fn(conn, $(this));
                }
            }

            checkedIds[peerId] = 1;
        });
    }

    // Show browser version
    $('#browsers').text(navigator.userAgent);
});

// Make sure things clean up properly.

window.onunload = window.onbeforeunload = function(e) {
    if (!!peer && !peer.destroyed) {
        peer.destroy();
    }
};

</script>
</head>

<body>
<div class="container">
    <div class="row">
    <div class="col-sm-2" id="peerbox">
        <p>Peers on server:</p>
        <hr style="margin-top: 0px;">
        <div id="peerlist">
        </div>
        <div class="peerlist-item" id="peerlist-item-template" hidden>
            <span id="peerlist-item-nickname"></span>
        </div>
    </div>
    <div class="col-sm-10" id="tools">
        <div id="actions">
            <p>Nickname: <input type="text" id="nickname" value="Anonymous" placeholder="Your nickname"><input class="button" type="button" value="Save" id="saveNickname"></p>
            <p>Connect to a peer: <input type="text" id="rid" placeholder="Someone else's id"><input class="button" type="button" value="Connect" id="connect"></p>

            <form id="send">
                <input type="text" id="text" placeholder="Enter message"><input class="button" type="submit" value="Send to selected peers">
            </form>
            <button id="close">Close selected connections</button>
        </div>

        <div id="wrap">
            <div id="connections"><span class="filler">You have not yet made any connections.</span></div>
            <div class="clear"></div>
        </div>

        <div id="box">
            Drag file here to send to active connections.
        </div>
    </div>
    </div>

    <div class="warning browser">
        <div class="important">Your browser version: <span id="browsers"></span><br>
        Currently <strong>Firefox 22+ and Google Chrome 26.0.1403.0 or above</strong> is required.</strong></div>
        For more up to date compatibility information see <a href="http://peerjs.com/status">PeerJS WebRTC Status</a><br>
        Note that this demo may also fail if you are behind stringent firewalls or both you and the remote peer and behind symmetric NATs.

    <div class="log"><strong>Connection status</strong>:<br></div>
    </div>
</div>
</body>
</html>
