<!DOCTYPE HTML>
<html lang="en">
<head>
<title>PeerJS chat demo</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Language" content="en-us">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="/css/fancy.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
<script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/js.cookie.js"></script>
<script type="text/javascript" src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.js"></script>

<script>
// Connect to PeerJS, have server assign an ID instead of providing one
// Showing off some of the configs available with PeerJS :).
var peer = new Peer({
    // Set API key for cloud server (you don't need this if you're running your
    // own.
    //key: 'x7fwx2kavpy6tj4i',
    host: window.location.hostname, port: window.location.port || null, path: '/peerjs',
    config: {'iceServers': [
        { url: 'stun:stun.l.google.com:19302' },
        { url: 'turn:homeo@turn.bistri.com:80', credential: 'homeo' }
    ]}, /* Sample servers, please use appropriate ones */

    // Set highest debug level (log everything!).
    debug: 3,

    // Set a logging function:
    logFunction: function() {
        if (arguments.length == 3 && arguments[2].type == 'PEER-LIST') {
            var peerList = arguments[2].payload.peers;
            $('.log').append('PEER-LIST ' + JSON.stringify(peerList) + '<br>');
            var domPeerList = $('#peerlist');
            domPeerList.empty();
            for (var i = 0; i < peerList.length; i ++) {
                var item = $('#peerlist-item-template').clone();
                item.removeAttr('id');
                item.attr('peerid', peerList[i][0]);
                item.find('#peerlist-item-nickname').text(peerList[i][1] || peerList[i][0]);
                if (peerList[i][0] == peer.id)
                    item.find('#peerlist-item-nickname').append(' (You)');
                if (peerList[i][0] == $('#rid').val())
                    item.addClass('active');
                domPeerList.append(item);
                item.show();
            }
            $('.peerlist-item').click(function() {
                if ($(this).attr('peerid') == peer.id)
                    return;
                $('.peerlist-item').removeClass("active");
                $(this).addClass('active');
                $("#rid").val($(this).attr("peerid"));
            });
            connectToFirstPeerOnOpen();
        } else {
            var copy = Array.prototype.slice.call(arguments).join(' ');
            $('.log').append(copy + '<br>');
        }
    }
});

var connectedToFirstPeerOnOpen = false;
function connectToFirstPeerOnOpen() {
    if (Object.keys(peer.connections).length)
        connectedToFirstPeerOnOpen = true;
    $("#peerlist .peerlist-item").each(function(k,v) {
        if (!connectedToFirstPeerOnOpen) {
            var peerid = $(v).attr('peerid');
            if (peerid != peer.id) {
                console.log(1);
                $('#rid').val(peerid);
                $('#connect').click();
                connectedToFirstPeerOnOpen = true;
            }
        }
    });
}

var connectedPeers = {};

// Show this peer's ID.
peer.on('open', function(id){
    // Set nickname
    var nickname = Cookies.get('nickname');
    $('#nickname').val(nickname);
    peer.socket.send({type: 'USERDEFINED', payload:{type: 'NICKNAME', payload: nickname}});
});

// Await connections from others
peer.on('connection', connect);

peer.on('error', function(err) {
    console.log(err);
})

function setPeerBoxHeight() {
    var toolsHeight = $('#tools').height();
    $('#peerbox').height(toolsHeight);
}

// Handle a connection object.
function connect(c) {
    // Handle a chat connection.
    setPeerBoxHeight();
    if (c.label === 'chat') {
        var chatbox = $('<div></div>').addClass('connection').addClass('active').attr('id', c.peer);
        var header = $('<div></div>').html('<p>Chat with <strong>' + c.peer + '</strong><p>').addClass('chatheader');
        var messages = $('<div><em>Peer connected.</em></div>').addClass('messages');
        chatbox.append(header);
        chatbox.append(messages);

        // Select connection handler.
        chatbox.on('click', function() {
            if ($(this).attr('class').indexOf('active') === -1) {
                $(this).addClass('active');
            } else {
                $(this).removeClass('active');
            }
        });
        $('.filler').hide();
        $('#connections').append(chatbox);

        c.on('data', function(data) {
            messages.append('<div><span class="peer">' + c.peer + '</span>: ' + data +
                '</div>');
                });
                c.on('close', function() {
                    alert(c.peer + ' has left the chat.');
                    chatbox.remove();
                    if ($('.connection').length === 0) {
                        $('.filler').show();
                    }
                    delete connectedPeers[c.peer];
                });
    } else if (c.label === 'file') {
        var nextType = null;
        c.on('data', function(data) {
            if (nextType == null) {
                console.assert(data.constructor === String);
                nextType = data;
            } else if (nextType == 'file') {
                // If we're getting a file, create a URL for it.
                console.assert(data.constructor === ArrayBuffer);
                var dataView = new Uint8Array(data);
                var dataBlob = new Blob([dataView]);
                var url = window.URL.createObjectURL(dataBlob);
                $('#' + c.peer).find('.messages').append('<div><span class="file">' +
                        c.peer + ' has sent you a <a target="_blank" href="' + url + '">file</a>.</span></div>');
                nextType = null;
            } else if (nextType == 'image') {
                console.assert(data.constructor === ArrayBuffer);
                var dataView = new Uint8Array(data);
                var dataBlob = new Blob([dataView]);
                var url = window.URL.createObjectURL(dataBlob);
                $('#' + c.peer).find('.messages').append('<div><span class="peer">' + c.peer + '</span>: <span><img class="recieved-image" src="' +
                        url + '"/></span></div>');
                nextType = null;
            } else if (nextType == 'video') {
                console.assert(data.constructor === ArrayBuffer);
                var dataView = new Uint8Array(data);
                var dataBlob = new Blob([dataView]);
                var url = window.URL.createObjectURL(dataBlob);
                $('#' + c.peer).find('.messages').append('<div><span class="peer">' + c.peer + '</span>: <span><video class="recieved-video" src="' +
                        url + '" controls="controls">Your browser does not support the video tag.</video></span></div>');
                nextType = null;
            }
        });
    }
    connectedPeers[c.peer] = 1;
}

$(document).ready(function() {
    // Set peerbox height
    setPeerBoxHeight();

    // Save nickname
    $('#saveNickname').click(function() {
        var nickname = $('#nickname').val();
        Cookies.set('nickname', nickname, { expires: 365 });
        peer.socket.send({type: 'USERDEFINED', payload: {type: 'NICKNAME', payload: nickname}});
    });

    // Prepare file drop box.
    var box = $('#box');
    box.on('dragenter', doNothing);
    box.on('dragover', doNothing);
    box.on('drop', function(e){
        e.originalEvent.preventDefault();
        var file = e.originalEvent.dataTransfer.files[0];
        eachActiveConnection(function(c, $c) {
            if (c.label === 'file' && c.open) {
                ftype = 'file';
                if (file.type.startsWith('image'))
                    ftype = 'image';
                else if (file.type.startsWith('video'))
                    ftype = 'video';
                else
                    ftype = 'file';
                c.send(ftype);
                c.send(file);
                var url = window.URL.createObjectURL(file);
                if (ftype == 'file')
                    $c.find('.messages').append('<div><span class="file">You sent a <a target="_blank" href="' + url + '">file</a>.</span></div>');
                else if (ftype == 'image')
                    $c.find('.messages').append('<div><span class="you">You: </span><span><img class="recieved-image" src="' +
                        url + '"/></span></div>');
                else if (ftype == 'video')
                    $c.find('.messages').append('<div><span class="you">You: </span><span><video class="recieved-video" src="' +
                        url + '" controls="controls">Your browser does not support the video tag.</video></span></div>');
            }
        });
    });
    function doNothing(e){
        e.preventDefault();
        e.stopPropagation();
    }

    // Connect to a peer
    $('#connect').click(function() {
        var requestedPeer = $('#rid').val();
        if (!connectedPeers[requestedPeer]) {
            // Create 2 connections, one labelled chat and another labelled file.
            var c = peer.connect(requestedPeer, {
                label: 'chat',
                serialization: 'none',
                metadata: {message: 'hi i want to chat with you!'}
            });
            c.on('open', function() {
                connect(c);
            });
            c.on('error', function(err) { alert(err); });
            var f = peer.connect(requestedPeer, { label: 'file', reliable: true });
            f.on('open', function() {
                connect(f);
            });
            f.on('error', function(err) { alert(err); });
        }
        connectedPeers[requestedPeer] = 1;
    });

    // Close a connection.
    $('#close').click(function() {
        eachActiveConnection(function(c) {
            c.close();
        });
    });

    // Send a chat message to all active connections.
    $('#send').submit(function(e) {
        e.preventDefault();
        // For each active connection, send the message.
        var msg = $('#text').val();
        eachActiveConnection(function(c, $c) {
            if (c.label === 'chat' && c.open) {
                c.send(msg);
                $c.find('.messages').append('<div><span class="you">You: </span>' + msg
                    + '</div>');
            }
        });
        $('#text').val('');
        $('#text').focus();
    });

    // Goes through each active peer and calls FN on its connections.
    function eachActiveConnection(fn) {
        var actives = $('.connection.active');
        var checkedIds = {};
        actives.each(function() {
            var peerId = $(this).attr('id');

            if (!checkedIds[peerId]) {
                var conns = peer.connections[peerId];
                for (var i = 0, ii = conns.length; i < ii; i += 1) {
                    var conn = conns[i];
                    fn(conn, $(this));
                }
            }

            checkedIds[peerId] = 1;
        });
    }

    // Show browser version
    $('#browsers').text(navigator.userAgent);
});

// Make sure things clean up properly.

window.onunload = window.onbeforeunload = function(e) {
    if (!!peer && !peer.destroyed) {
        peer.destroy();
    }
};

</script>
</head>

<body>
<div class="container">
    <div class="row">
    <div class="col-sm-2" id="peerbox">
        <p>Peers on server:</p>
        <hr style="margin-top: 0px;">
        <div id="peerlist">
        </div>
        <div class="peerlist-item" id="peerlist-item-template" hidden>
            <span id="peerlist-item-nickname"></span>
        </div>
    </div>
    <div class="col-sm-10" id="tools">
        <div id="actions">
            <p>Nickname: <input type="text" id="nickname" value="Anonymous" placeholder="Your nickname"><input class="button" type="button" value="Save" id="saveNickname"></p>
            <p>Connect to a peer: <input type="text" id="rid" placeholder="Someone else's id"><input class="button" type="button" value="Connect" id="connect"></p>

            <form id="send">
                <input type="text" id="text" placeholder="Enter message"><input class="button" type="submit" value="Send to selected peers">
            </form>
            <button id="close">Close selected connections</button>
        </div>

        <div id="wrap">
            <div id="connections"><span class="filler">You have not yet made any connections.</span></div>
            <div class="clear"></div>
        </div>

        <div id="box">
            Drag file here to send to active connections.
        </div>
    </div>
    </div>

    <div class="warning browser">
        <div class="important">Your browser version: <span id="browsers"></span><br>
        Currently <strong>Firefox 22+ and Google Chrome 26.0.1403.0 or above</strong> is required.</strong></div>
        For more up to date compatibility information see <a href="http://peerjs.com/status">PeerJS WebRTC Status</a><br>
        Note that this demo may also fail if you are behind stringent firewalls or both you and the remote peer and behind symmetric NATs.

    <div class="log"><strong>Connection status</strong>:<br></div>
    </div>
</div>
</body>
</html>
