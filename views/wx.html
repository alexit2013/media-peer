<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>PeerJS</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/img/favicon31e225.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="/css/base31e225.css">
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/jQuery.md5.js"></script>
    <script type="text/javascript" src="/js/peer.min.js"></script>
    <script type="text/javascript" src="/js/js.cookie.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
    <style type="text/css">
.warning {
  font-size: 12px;
  line-height: 20px;
  padding: 10px;
  margin-right: 50px;
  margin-left: 50px;
  background-color: #333;
  color: #fff;
  text-shadow: 0 1px 0 rgba(0,0,0,0.4);
  font-weight: 300;
  border-width: 1px 0;
  border-color: #000;
  border-style: solid;
}
    </style>
</head>
<body>
    <div class="main" style="display:block">
        <div class="main_inner">
            <div class="panel">
                <div class="header">
                    <div class="avatar">
                        <img id="peer_nicknameAvatar" class="img">
                    </div>
                    <div class="info">
                        <h3 class="nickname">
                            <span id="peer_nickname" class="display_name ng-binding" contenteditable="true"></span>
                            <a class="opt" href="javascript:;"><i class="web_wechat_add"></i></a>
                        </h3>
                    </div>
                </div>
                <div class="search_bar" id="search_bar">
                    <i class="web_wechat_search"></i>
                    <input class="frm_search ng-isolate-scope ng-pristine ng-valid" type="text" placeholder="搜索">
                </div>
                <div class="tab">
                    <div class="tab_item">
                        <a class="chat" title="聊天" href="#"><i class="web_wechat_tab_chat web_wechat_tab_chat_hl"></i></a>
                    </div>
                    <div class="tab_item ng-scope">
                        <a class="chat" title="阅读" href="#"><i class="web_wechat_tab_public"></i></a>
                    </div>
                    <div class="tab_item no_extra">
                        <a class="chat" title="通讯录" href="#"><i class="web_wechat_tab_friends"></i></a>
                    </div>
                </div>
                <div id="navView" class="ng-scope"></div>
                <div class="nav_view ng-scope">
                    <div class="scroll-wrapper chat_list scrollbar-dynamic" style="position: relative;">
                        <div id="J_NavChatScrollBody" class="chat_list scrollbar-dynamic scroll-scrolly_visible">
                            <!-- peer list -->
                        </div>
                        <div hidden>
                            <div id="peer_listItemTemplate" class="ng-scope">
                                <div class="peer_listItemChatItem chat_item slide-left ng-scope">
                                    <div class="avatar">
                                        <img id="peer_nicknameAvatar" class="img" alt="">
                                    </div>
                                    <div class="info">
                                        <h3 class="nickname">
                                            <span id="peer_nicknameText" class="nickname_text ng-binding">Tsinghua</span>
                                        </h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="height:100%" class="ng-scope">
                <div id="chatArea" class="box chat ng-scope no-choose">
                    <div class="box_hd">
                        <div class="title_wrap">
                            <div class="title poi">
                                <a id="peer_titleName" class="title_name ng-binding"></a>
                                <i id="peer_downIcon" class="web_wechat_down_icon" style="display: none;"></i>
                            </div>
                        </div>
                    </div>
                    <div id="peer_noChatHint" class="scroll-wrapper box_bd chat_bd scrollbar-dynamic" style="position: absolute;">
                        <div class="box_bd chat_bd scrollbar-dynamic scroll-content" style="margin-bottom: 0px; margin-right: 0px; height: 509px;">
                            <div class="message_empty ng-scope">
                                <i class="web_wechat_nomes_icon"></i>
                                <p class="ng-hide">暂时没有新消息</p>
                                <p class="">未选择聊天</p>
                            </div>
                        </div>
                    </div>
                    <div id="peer_chatAreaTemplate" class="peer_chatAreaItem scroll-wrapper box_bd chat_bd scrollbar-dynamic" style="position: absolute;" hidden>
                        <div id="peer_chatMessageBox" class="box_bd chat_bd scrollbar-dynamic " style="height: 100%; top: 0; margin-bottom: 0px; margin-right: 0px; overflow: scroll;">
                            <div class="ng-scope">
                                <div class="clearfix" style="overflow: hidden;">
                                    <div class="message ng-scope me">
                                        <p class="message_system ng-scope"><span class="content ng-binding">Today</span></p>
                                    </div>
                                </div>
                            </div>
                            <div id="peer_chatMessageMeTemplate" class="ng-scope" hidden><!-- MESSAGE -->
                                <div class="clearfix" style="overflow: hidden;">
                                    <div class="message ng-scope me">
                                        <img id="peer_chatMessageAvatar" class="avatar">
                                        <div class="content">
                                            <div class="bubble js_message_bubble ng-scope bubble_primary right">
                                                <div class="bubble_cont ng-scope">
                                                    <div id="peer_chatMessageMessagePlaceholder" class="plain">
                                                        <pre class="js_message_plain ng-binding">[message]</pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="peer_chatMessageYouTemplate" class="ng-scope" hidden><!-- MESSAGE -->
                                <div class="clearfix" style="overflow: hidden;">
                                    <div class="message ng-scope you">
                                        <img id="peer_chatMessageAvatar" class="avatar">
                                        <div class="content">
                                            <div class="bubble js_message_bubble ng-scope bubble_default left">
                                                <div class="bubble_cont ng-scope">
                                                    <div id="peer_chatMessageMessagePlaceholder" class="plain">
                                                        <pre class="js_message_plain ng-binding">[message]</pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="peer_inputComponent" class="box_ft ng-scope" style="display: none;">
                        <div class="toolbar" id="tool_bar">
                            <a class="web_wechat_face" href="javascript:;" title="表情"></a>
                            <a class="web_wechat_screencut ng-isolate-scope" href="javascript:;" title="截屏"></a>
                            <a class="web_wechat_pic js_fileupload ng-isolate-scope webuploader-container" href="javascript:;" title="图片和文件"><div class="webuploader-pick"></div><div id="rt_rt_1b4tmjj8t149219br14cp1jha1ldv1" style="position: absolute; top: 0px; left: 0px; width: 30px; height: 30px; overflow: hidden; bottom: auto; right: auto;"><input type="file" name="file" class="webuploader-element-invisible" multiple="multiple"><label style="opacity: 0; width: 100%; height: 100%; display: block; cursor: pointer; background: rgb(255, 255, 255);"></label></div></a>
                        </div>
                        <div class="content ng-isolate-scope">
                            <pre id="editArea" class="flex edit_area ng-isolate-scope ng-valid ng-dirty" contenteditable="true" ></pre>
                            <span class="caret_pos_helper" id="caretPosHelper"></span>
                        </div>
                        <div class="action">
                            <span class="desc ng-scope">按下Enter换行</span>
                            <a id="peer_sendMessage" class="btn btn_send" href="javascript:;">发送</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container" hidden>
        <div class="warning browser">
            <div class="important">Your browser version: <span id="browsers"></span><br>
            Currently <strong>Firefox 22+ and Google Chrome 26.0.1403.0 or above</strong> is required.</div>
            For more up to date compatibility information see <a href="http://peerjs.com/status">PeerJS WebRTC Status</a><br>
            Note that this demo may also fail if you are behind stringent firewalls or both you and the remote peer and behind symmetric NATs.
        <div id="log"><strong>Connection status</strong>:<br></div>
        </div>
    </div>
</body>
<script type="text/javascript">
var peerList = [];
var peerid2nickname = {};
var peerActive = null;

/*var */peer = new Peer({
    host: window.location.hostname, port: window.location.port || null, path: '/peerjs',
    config: {'iceServers': [
        { url: 'stun:stun.l.google.com:19302' },
        { url: 'turn:homeo@turn.bistri.com:80', credential: 'homeo' }
    ]},
    debug: 3,
    logFunction: function() {
        if (arguments.length == 3 && arguments[2].type == 'PEER-LIST') {
            peerList = arguments[2].payload.peers;
            $('#log').append('PEER-LIST ' + JSON.stringify(peerList) + '<br>');
            var navBox = $('#J_NavChatScrollBody');
            navBox.empty();
            for (var i = 0; i < peerList.length; i++) {
                var peerid = peerList[i][0];
                var peernick = peerList[i][1];
                peerid2nickname[peerid] = peernick;
                if (peerid == peer.id)
                    continue;
                var item = $('#peer_listItemTemplate').clone();
                item.removeAttr('id');
                item.attr('peerid', peerid);
                item.find('#peer_nicknameText').text(peernick || peerid);
                item.find('#peer_nicknameAvatar').attr('src', avatarUrl(peernick));
                item.click(function() {
                    var peerid = $(this).attr('peerid');
                    if (!peer.connections[peerid]) {
                        var c = peer.connect(peerid, {
                            label: 'chat',
                            serialization: 'none',
                            metadata: {message: 'hi i want to chat with you!'}
                        });
                        var f = peer.connect(peerid, { label: 'file', reliable: true });
                        c.on('open', function() {
                            connect(this);
                        });
                        c.on('error', function(err) { alert(err); });
                        f.on('open', function() {
                            connect(this);
                        });
                        f.on('error', function(err) { alert(err); });
                    }
                    peerActive = peerid;
                    updateActiveView();
                });
                navBox.append(item);
            }
            updateActiveView();
            autoConnectToFirstPeerForDebug();
        } else {
            var copy = Array.prototype.slice.call(arguments).join(' ');
            $('#log').append(copy + '<br>');
        }
    }
});

peer.on('open', function(id){
    updatePeerNicknameAvatar();
});

peer.on('connection', connect);

peer.on('error', function(err) {
    console.log(err);
});

function connect(c) {
    // Handle a chat connection.
    if (c.label === 'chat') {
        var he = peer.connections[c.peer];
        he.chatArea = createChatArea(c.peer);
        c.on('data', function(data) {
            var pre = $('<pre class="js_message_plain"></pre>');
            pre.text(data);
            appendToChatBox(c.peer, pre, false);
        });
        c.on('close', function() {
            var peerid = c.peer;
            var he = peer.connections[peerid];
            if (he.chatArea) {
                he.chatArea.remove();
                delete he.chatArea;
            }
            if (peerid == peerActive)
                peerActive = null;
            updateActiveView();
        });
        updateActiveView();
    } else if (c.label === 'file') {
        c.on('data', function(data) {
            if (data.type == 'video') {
            } else if (data.type == 'image') {
                console.assert(data.file.constructor === ArrayBuffer);
                var dataView = new Uint8Array(data.file);
                var dataBlob = new Blob([dataView]);
                var url = window.URL.createObjectURL(dataBlob);
                var img = $('<img style="max-height: 200px; max-width: 300px;"/>');
                img.attr('src', url);
                appendToChatBox(c.peer, img, false);
            } else {
                console.assert(data.type == 'file');
                // If we're getting a file, create a URL for it.
                console.assert(data.file.constructor === ArrayBuffer);
                var dataView = new Uint8Array(data.file);
                var dataBlob = new Blob([dataView]);
                var url = window.URL.createObjectURL(dataBlob);
                var div = $('<div>You recieved a <a target="_blank">file</a>.</div>');
                div.find('a').attr('href', url);
                appendToChatBox(c.peer, div, false);
            }
        });
    }
}

$(document).ready(function() {
    $('#browsers').text(navigator.userAgent);

    $('#peer_nickname').focusout(function() {
        var nickname = $('#peer_nickname').text();
        Cookies.set('nickname', nickname, { expires: 365 });
        updatePeerNicknameAvatar();
    });

    $('#peer_sendMessage').click(function() {
        var text = $('#editArea').text();
        if (peerActive && peer.connections[peerActive] && text) {
            activeConnectionSend('chat', text);
            $('#editArea').empty();
            var pre = $('<pre class="js_message_plain"></pre>');
            pre.text(text);
            appendToChatBox(peerActive, pre, true);
        }
    });
    
    function doNothing(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    var box = $('body');
    box.on('dragenter', doNothing);
    box.on('dragover', doNothing);
    box.on('drop', function(e) {
        e.originalEvent.preventDefault();
        if (peerActive && peer.connections[peerActive]) {
            var file = e.originalEvent.dataTransfer.files[0];
            if (file.type.startsWith('video')) {
            } else if (file.type.startsWith('image')) {
                activeConnectionSend('file', {type: 'image', file: file});
                var url = window.URL.createObjectURL(file);
                var img = $('<img style="max-height: 200px; max-width: 300px;"/>');
                img.attr('src', url);
                appendToChatBox(peerActive, img, true);
            } else {
                activeConnectionSend('file', {type: 'file', file: file});
                var url = window.URL.createObjectURL(file);
                var div = $('<div>You sent a <a target="_blank">file</a>.</div>');
                div.find('a').attr('href', url);
                appendToChatBox(peerActive, div, true);
            }
        }
    });
});

// Make sure things clean up properly.
window.onunload = window.onbeforeunload = function(e) {
    if (!!peer && !peer.destroyed) {
        peer.destroy();
    }
};

//********
// UTILS
//********

function updatePeerNicknameAvatar() {
    var nickname = Cookies.get('nickname');
    $('#peer_nickname').text(nickname);
    $('#peer_nicknameAvatar').attr('src', avatarUrl(nickname));
    var recurse = function() {
        if (peer.socket._wsOpen())
            peer.socket.send({type: 'USERDEFINED', payload:{type: 'NICKNAME', payload: nickname}});
        else
            setTimeout(recurse, 100);
    };
    recurse();
}

function avatarUrl(email) {
    return 'http://gravatar.com/avatar/' + $.md5(email || '') + '?default=retro';
}

function updateActiveView() {
    $('.peer_listItemChatItem').removeClass('active');
    $('.peer_chatAreaItem').hide();
    if (peerActive) {
        $('#J_NavChatScrollBody div[peerid=' + peerActive + '] .peer_listItemChatItem').addClass('active');
        $('#peer_titleName').text(peerid2nickname[peerActive] || peerActive);
        $('#peer_downIcon').show();
        $('.peer_chatAreaItem[peerid=' + peerActive + ']').show();
        $('#peer_noChatHint').hide();
        $('#peer_inputComponent').show();
    } else {
        $('#peer_titleName').text('');
        $('#peer_downIcon').hide();
        $('#peer_noChatHint').show();
        $('#peer_inputComponent').hide();
    }
}

function createChatArea(peerid) {
    chatArea = $('#peer_chatAreaTemplate').clone();
    chatArea.removeAttr('id');
    chatArea.removeAttr('hidden');
    chatArea.attr('peerid', peerid);
    $('#chatArea').append(chatArea);
    return chatArea;
}

function appendToChatBox(peerid, html, mine) {
    var chatbox = $('.peer_chatAreaItem[peerid=' + peerid + ']').find('#peer_chatMessageBox');
    var his = $('#peer_chatAreaTemplate').find(mine ? '#peer_chatMessageMeTemplate' : '#peer_chatMessageYouTemplate').clone();
    his.removeAttr('id');
    his.removeAttr('hidden');
    var placeholder = his.find('#peer_chatMessageMessagePlaceholder');
    placeholder.empty();
    placeholder.html(html);
    his.find('#peer_chatMessageAvatar').attr('src', avatarUrl(peerid2nickname[peerid]));
    chatbox.append(his);
    chatbox.scrollTop(chatbox.height());
    if (!peerActive) {
        peerActive = peerid;
        updateActiveView();
    }
}

function activeConnectionSend(label, data) {
    if (peerActive && peer.connections[peerActive]) {
        $.each(peer.connections[peerActive], function(idx, c) {
            if (c.label == label && c.open)
                c.send(data)
        });
    }
}

function autoConnectToFirstPeerForDebug() {
    if (!peerActive) {
        $.each(peerList, function(idx, peertuple) {
            var peerid = peertuple[0];
            if (!peerActive && peerid != peer.id) {
                $('#J_NavChatScrollBody [peerid=' + peerid + ']').click();
            }
        });
    }
}

</script>
</html>
